<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NepHR App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #508C7F; font-family: -apple-system, system-ui, sans-serif; }
        #gatekeeper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #508C7F; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            color: white; text-align: center; display: none;
        }
        .unlock-btn { padding: 20px; cursor: pointer; }
        .icon-circle { width: 70px; height: 70px; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="gatekeeper">
        <img src="icon.png" style="width:90px; border-radius:20px; margin-bottom:25px;">
        <div class="unlock-btn" onclick="requestBiometric()">
            <div class="icon-circle"><i class="fas fa-fingerprint"></i></div>
            <h2>Unlock NepHR</h2>
            <p>Touch sensor to sign in</p>
        </div>
    </div>

    <iframe id="appFrame" src="https://script.google.com/macros/s/AKfycbxuviY7LYQyFN4fJZ4_mAaYzf1pTyQ7qkFrbcSOZPt6WHJd9tX-eY2w87NOwOqMu42f/exec" allow="geolocation"></iframe>

    <script>
        const frame = document.getElementById('appFrame');
        const gatekeeper = document.getElementById('gatekeeper');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const savedToken = localStorage.getItem('sessionToken');

        window.onload = function() {
            if (isMobile && savedToken) {
                // If Mobile and we have a saved login, show Biometric Gate
                gatekeeper.style.display = 'flex';
                requestBiometric();
            } else {
                // If Laptop OR first time login, load system normally
                loadSystem();
            }
        };

        // Trigger Phone hardware security
        async function requestBiometric() {
            if (window.PublicKeyCredential) {
                try {
                    const challenge = crypto.getRandomValues(new Uint8Array(32));
                    await navigator.credentials.get({
                        publicKey: { challenge, timeout: 60000, userVerification: "required" }
                    });
                    // On Success: Tell HR System to auto-login with saved token
                    loadSystem(savedToken);
                } catch (e) { console.log("Biometric cancelled or failed"); }
            } else { loadSystem(); }
        }

        function loadSystem(token = null) {
            gatekeeper.style.display = 'none';
            if (token) {
                // Send the token to the Google Script iframe
                frame.src = "YOUR_GOOGLE_SCRIPT_URL_HERE" + "?token=" + token;
            }
        }

        // Listen for "Login Successful" from HR System to save the token
        window.addEventListener("message", (event) => {
            if (event.data.type === "LOGIN_SUCCESS") {
                localStorage.setItem('sessionToken', event.data.token);
            }
        });
    </script>
</body>
</html>
